<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>automate_de_tesselation 2D</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 {
      color: #333;
    }
    #2d-graph {
      width: 100%;
      height: 800px;
      border: 1px solid #ccc;
    }
    #loading {
      text-align: center;
      font-style: italic;
      color: #777;
    }
    #controls {
      margin-bottom: 15px;
    }
    .group-button {
      padding: 8px 16px;
      margin-right: 10px;
      background-color: #757575;
      border: none;
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }
    .group-button:hover {
      background-color: #4F4F4F;
    }
    .group-button.active {
      background-color: #050505;
    }

    /* === SCORE DISPLAY avec animation === */
    #score-display {
      display: inline-block;
      margin-top: 10px;
      margin-left: 10px;
      font-weight: bold;
      font-size: 20px;          
      color: #FFFFFF;
      background-color: #050505;
      padding: 5px 10px;        /* épaisseur autour du texte */
      border-radius: 5px;
      transition: transform 0.0s ease, #757575 0.0s ease;
    }

    /* Animation lors de la mise à jour */
    #score-display.updated {
      transform: scale(1.0);
      background-color: #757575;
    }

    /* effet de lueur douce */
    @keyframes glow {
      0% { box-shadow: 0 0 0px #757575; }
      50% { box-shadow: 0 0 20px #757575; }
      100% { box-shadow: 0 0 0px #757575; }
    }

    #score-display.glow {
      animation: glow 0.0s ease;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>automate_de_tesselation: |V|=9, |E|=13</h1>

    <div id="controls">
      <span>Description scales :</span>
      <div id="group-buttons" style="display:inline-block; margin-left:10px;"></div>
      <span id="score-display"></span>
    </div>

    <div id="loading">Chargement du graphe...</div>
    <div id="2d-graph"></div>
  </div>

  <!-- Librairie locale -->
  <script src="../VascoAsturiano-libs/2d-force-graph.min.js"></script>

  <!-- Données intégrées -->
  <script type="application/json" id="graph-data">
        {
         "scales": [
            {"s":0.5, "score": "|C|=4: P=1.00, R=0.54, F0.50=0.70, F0.5=0.70"},
            {"s":0.525, "score": "|C|=2: P=0.62, R=0.77, F0.50=0.69, F0.525=0.70"},
            {"s":0.55, "score": "|C|=2: P=0.62, R=0.77, F0.50=0.69, F0.55=0.70"},
            {"s":0.575, "score": "|C|=2: P=0.62, R=0.77, F0.50=0.69, F0.575=0.71"},
            {"s":0.6, "score": "|C|=2: P=0.62, R=0.77, F0.50=0.69, F0.6=0.71"},
            {"s":0.625, "score": "|C|=2: P=0.62, R=0.77, F0.50=0.69, F0.625=0.72"},
            {"s":0.65, "score": "|C|=2: P=0.62, R=0.77, F0.50=0.69, F0.65=0.72"},
            {"s":0.675, "score": "|C|=2: P=0.62, R=0.77, F0.50=0.69, F0.675=0.73"},
            {"s":0.7, "score": "|C|=2: P=0.62, R=0.77, F0.50=0.69, F0.7=0.73"},
            {"s":0.725, "score": "|C|=2: P=0.43, R=0.92, F0.50=0.59, F0.725=0.77"},
            {"s":0.75, "score": "|C|=1: P=0.36, R=1.00, F0.50=0.53, F0.75=0.79"},
            {"s":0.775, "score": "|C|=1: P=0.36, R=1.00, F0.50=0.53, F0.775=0.83"},
            {"s":0.8, "score": "|C|=1: P=0.36, R=1.00, F0.50=0.53, F0.8=0.86"},
            {"s":0.85, "score": "|C|=1: P=0.36, R=1.00, F0.50=0.53, F0.85=0.91"},
            {"s":0.9, "score": "|C|=1: P=0.36, R=1.00, F0.50=0.53, F0.9=0.96"},
            {"s":0.95, "score": "|C|=1: P=0.36, R=1.00, F0.50=0.53, F0.95=0.99"},
            {"s":1.0, "score": "|C|=1: P=0.36, R=1.00, F0.50=0.53, F1.0=1.00"}
        ],
          "nodes": [
            {"id": 0, "name": "0", "deg": 3, "group": [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]},
            {"id": 1, "name": "1", "deg": 4, "group": [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]},
            {"id": 2, "name": "2", "deg": 2, "group": [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]},
            {"id": 3, "name": "3", "deg": 3, "group": [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]},
            {"id": 4, "name": "4", "deg": 3, "group": [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]},
            {"id": 5, "name": "5", "deg": 3, "group": [3, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0]},
            {"id": 6, "name": "6", "deg": 3, "group": [3, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0]},
            {"id": 7, "name": "7", "deg": 1, "group": [0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0]},
            {"id": 8, "name": "8", "deg": 4, "group": [3, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0]}
        ],
         "links": [
            {"source": 0, "target": 2, "value": 1.00},
            {"source": 0, "target": 4, "value": 1.00},
            {"source": 4, "target": 5, "value": 1.00},
            {"source": 2, "target": 3, "value": 1.00},
            {"source": 0, "target": 1, "value": 1.00},
            {"source": 1, "target": 8, "value": 1.00},
            {"source": 1, "target": 4, "value": 1.00},
            {"source": 1, "target": 3, "value": 1.00},
            {"source": 3, "target": 8, "value": 1.00},
            {"source": 5, "target": 8, "value": 1.00},
            {"source": 6, "target": 8, "value": 1.00},
            {"source": 5, "target": 6, "value": 1.00},
            {"source": 6, "target": 7, "value": 1.00}
          ]
        }
  </script>

  <script>
    window.addEventListener("load", () => {
      const rawData = document.getElementById("graph-data").textContent;
      const data = JSON.parse(rawData);

      const NODE_R = 8;
      data.nodes.forEach(n => n.val = n.deg*NODE_R);

      const Graph = ForceGraph()(document.getElementById("2d-graph"))
        .graphData(data)
        .nodeAutoColorBy(node => node.group[0])
        .nodeRelSize(1)
        .backgroundColor("#fff")
        .linkWidth(0.5)
        .enableNodeDrag(true)
        .nodeCanvasObject((node, ctx, globalScale) => {
          const label = node.name;
          const fontSize = 12 / globalScale;
          ctx.fillStyle = node.color;
          ctx.beginPath();
          ctx.arc(node.x, node.y, 5, 0, 2 * Math.PI, false);
          ctx.fill();

          ctx.font = `${fontSize}px Sans-Serif`;
          ctx.textAlign = "left";
          ctx.textBaseline = "top";
          ctx.fillStyle = "black";
          ctx.fillText(label, node.x, node.y + 6);
        })
        .nodePointerAreaPaint((node, color, ctx) => {
          ctx.fillStyle = color;
          ctx.beginPath();
          ctx.arc(node.x, node.y, 8, 0, 2 * Math.PI, false);
          ctx.fill();
        })
        function hexToRgb(hex) {
      const res = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return res ? [
        parseInt(res[1], 16),
        parseInt(res[2], 16),
        parseInt(res[3], 16)
      ] : [0, 0, 0];
    }

    function rgbToHex(r, g, b) {
      const toHex = x => x.toString(16).padStart(2, "0");
      return "#" + toHex(r) + toHex(g) + toHex(b);
    }

    function averageColor(c1, c2) {
      const [r1, g1, b1] = hexToRgb(c1);
      const [r2, g2, b2] = hexToRgb(c2);
      const r = Math.round((r1 + r2) / 2);
      const g = Math.round((g1 + g2) / 2);
      const b = Math.round((b1 + b2) / 2);
      return rgbToHex(r, g, b);
    }

    function updateLinkColors() {
      data.links.forEach(link => {
        const srcNode = typeof link.source === "object" ? link.source : data.nodes.find(n => n.id === link.source);
        const tgtNode = typeof link.target === "object" ? link.target : data.nodes.find(n => n.id === link.target);
        const c1 = srcNode.color || "#000000";
        const c2 = tgtNode.color || "#000000";
        link.color = averageColor(c1, c2);
      });
    }

      setTimeout(() => {
        updateLinkColors();
        Graph.graphData(data);
        document.getElementById("loading").style.display = "none";
      }, 500);

      // --- Création des boutons ---
      const groupButtonsContainer = document.getElementById("group-buttons");
      const scoreDisplay = document.getElementById("score-display");
      const scales = data.scales || [];
      const maxGroupLength = Math.max(...data.nodes.map(n => n.group.length));
      const numButtons = Math.min(scales.length, maxGroupLength);
      const initButtons = ~~(numButtons / 2);
      Graph.nodeAutoColorBy(node => node.group[initButtons]);

      function setScoreText(index) {
        if (scales[index]) {
          scoreDisplay.textContent = scales[index]["score"];

          // --- Animation du score ---
          scoreDisplay.classList.add("updated", "glow");
          setTimeout(() => {
            scoreDisplay.classList.remove("updated", "glow");
          }, 600);
        } else {
          scoreDisplay.textContent = "";
        }
      }

      for (let i = 0; i < numButtons; i++) {
        const btn = document.createElement("button");
        btn.textContent = scales[i]["s"];
        btn.classList.add("group-button");
        if (i === initButtons) {
          btn.classList.add("active");
          setScoreText(i);
        }

        btn.addEventListener("click", () => {
          document.querySelectorAll(".group-button").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");

          data.nodes.forEach(n => delete n.color);

          Graph.nodeAutoColorBy(node => node.group[i]);
          Graph.graphData(data);

          setTimeout(() => {
            updateLinkColors();
            Graph.graphData(data);
          }, 300);

          setScoreText(i);
        });

        groupButtonsContainer.appendChild(btn);
      }
    });
  </script>
</body>
</html>
